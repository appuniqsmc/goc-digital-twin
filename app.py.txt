import streamlit as st
import pandas as pd
import joblib

model = joblib.load("GoC_Digital_Twin_Model.pkl")

st.title("Onco ICU Goals of Care Digital Twin")

st.header("Enter Patient Details")

age = st.slider("Age", 18, 95, 60)
gcs = st.slider("GCS", 3, 15, 12)
cci = st.slider("Charlson Index", 0, 10, 2)

diagnosis = st.selectbox(
"Diagnosis",
["Sepsis","Stroke","Cardiac Arrest","Pneumonia"]
)

vent = st.selectbox(
"Mechanical Ventilation",
["Yes","No"]
)

malignancy = st.selectbox(
"Active Malignancy",
["Controlled","Progressive","Newly Diagnosed"]
)

prognosis = st.selectbox(
"Clinical Prognosis",
["Good","Moderate","Poor"]
)

family = st.selectbox(
"Family Preference",
["Aggressive","Comfort","Undecided"]
)

icu_day = st.slider("ICU Day",1,20,3)

physician = st.selectbox(
"Physician Level",
["Resident","Attending","Specialist"]
)

if st.button("Predict Goals of Care"):

patient = pd.DataFrame({
"Patient_ID":[999],
"Age":[age],
"GCS":[gcs],
"Charlson_Comorbidity_Index":[cci],
"Diagnosis":[diagnosis],
"Prior_ICU_Admission":["No"],
"Active_Malignancy":[malignancy],
"Mechanical_Ventilation":[vent],
"Clinical_Prognosis":[prognosis],
"Family_Preference":[family],
"ICU_Day":[icu_day],
"Physician_Level":[physician]
})

patient_encoded = pd.get_dummies(patient)

patient_encoded = patient_encoded.reindex(
columns=model.feature_names_in_,
fill_value=0
)

pred = model.predict(patient_encoded)[0]
prob = model.predict_proba(patient_encoded)[0]

st.subheader("Prediction")
st.success(pred)

st.subheader("Probabilities")

for c,p in zip(model.classes_, prob):
st.write(f"{c}: {round(p*100,2)}%")